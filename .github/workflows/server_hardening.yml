name: Server Hardening Tests

on:
  push:
    branches:
      - main
    paths:
      - scripts/server_hardening.sh
      - .github/workflows/server_hardening.yml
  pull_request:
    paths:
      - scripts/server_hardening.sh
      - .github/workflows/server_hardening.yml

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shell linters
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt

      - name: ShellCheck
        run: shellcheck scripts/server_hardening.sh

      - name: shfmt
        run: shfmt -i 4 -ci -sr -d scripts/server_hardening.sh

  e2e:
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-22-04
            image: ubuntu:22.04
            init_cmd: |
              set -e
              export DEBIAN_FRONTEND=noninteractive
              apt-get update
              apt-get install -y systemd systemd-sysv
              exec /lib/systemd/systemd
            firewall: ufw
            ssh_service: ssh
          - name: debian-12
            image: debian:12
            init_cmd: |
              set -e
              export DEBIAN_FRONTEND=noninteractive
              apt-get update
              apt-get install -y systemd systemd-sysv
              exec /lib/systemd/systemd
            firewall: ufw
            ssh_service: ssh
          - name: rocky-9
            image: quay.io/rockylinux/rockylinux:9
            init_cmd: |
              set -e
              dnf install -y systemd
              exec /usr/lib/systemd/systemd
            firewall: firewalld
            ssh_service: sshd
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Launch systemd container
        env:
          INIT_CMD: ${{ matrix.init_cmd }}
        run: |
          container="${{ matrix.name }}"
          docker run --name "$container" \
            --privileged --cgroupns host \
            --tmpfs /tmp --tmpfs /run --tmpfs /run/lock \
            -e container=docker \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            -d "${{ matrix.image }}" bash -lc "$INIT_CMD"

      - name: Wait for systemd to initialize
        run: |
          container="${{ matrix.name }}"
          docker exec "$container" bash -lc '
            until systemctl list-units >/dev/null 2>&1; do
              sleep 2
            done
          '

      - name: Bootstrap prerequisites
        run: |
          container="${{ matrix.name }}"
          docker exec "$container" bash -lc '
            set -euo pipefail
            if command -v apt-get >/dev/null 2>&1; then
              export DEBIAN_FRONTEND=noninteractive
              apt-get update
              apt-get install -y sudo openssh-server ufw iproute2
              systemctl enable ssh
              systemctl start ssh
              if ! id dormantuser >/dev/null 2>&1; then
                useradd -m -s /bin/bash dormantuser
              fi
            else
              dnf install -y sudo openssh-server firewalld which
              systemctl enable sshd
              systemctl start sshd
              if ! id dormantuser >/dev/null 2>&1; then
                useradd -m -s /bin/bash dormantuser
              fi
            fi
          '

      - name: Copy repository into container
        run: |
          container="${{ matrix.name }}"
          docker cp . "$container:/srv/hardening"

      - name: Run server hardening script
        run: |
          container="${{ matrix.name }}"
          docker exec "$container" bash -lc '
            set -euo pipefail
            cd /srv/hardening
            chmod +x scripts/server_hardening.sh
            ./scripts/server_hardening.sh --non-interactive --skip-updates --enable-log-monitoring --inactive-threshold 0
          '

      - name: Validate hardened state
        env:
          FIREWALL: ${{ matrix.firewall }}
          SSH_SERVICE: ${{ matrix.ssh_service }}
        run: |
          container="${{ matrix.name }}"
          docker exec -e FIREWALL="$FIREWALL" -e SSH_SERVICE="$SSH_SERVICE" "$container" bash -lc '
            set -euo pipefail
            echo "=== SSH Configuration ==="
            grep -q "^Port 2200" /etc/ssh/sshd_config
            systemctl status "$SSH_SERVICE" --no-pager

            echo "=== Firewall Status (${FIREWALL}) ==="
            if [ "$FIREWALL" = "ufw" ]; then
              ufw status verbose
              ufw status | grep -q "2200"
            else
              zone=$(firewall-cmd --get-default-zone)
              echo "Firewalld default zone: $zone"
              firewall-cmd --zone="$zone" --list-all
              firewall-cmd --zone="$zone" --list-ports | grep -q "2200/tcp" || firewall-cmd --zone="$zone" --list-services | grep -q "\<ssh\>"
            fi

            echo "=== Fail2Ban ==="
            systemctl status fail2ban --no-pager
            systemctl is-enabled fail2ban >/dev/null

            echo "=== Kernel Parameters ==="
            sysctl net.ipv4.tcp_syncookies
            sysctl net.ipv4.conf.all.accept_source_route
            sysctl net.ipv4.ip_forward
            sysctl net.ipv6.conf.all.disable_ipv6
            sysctl net.ipv4.tcp_syncookies | grep -q "= 1"

            echo "=== User Account Hardening ==="
            passwd -S dormantuser
            status=$(passwd -S dormantuser | awk "{print \$2}")
            [ "$status" = "L" ] || [ "$status" = "LK" ]
            chage -l dormantuser | tee /tmp/chage.txt
            grep -Eq "Account expires.*1970" /tmp/chage.txt
            grep -Eq "^PASS_MAX_DAYS[[:space:]]+90" /etc/login.defs
            grep -Eq "^PASS_MIN_DAYS[[:space:]]+1" /etc/login.defs
            grep -Eq "^PASS_WARN_AGE[[:space:]]+14" /etc/login.defs
            dropin=/etc/security/pwquality.conf.d/99-server-hardening.conf
            test -f "$dropin"
            grep -Eq "^minlen[[:space:]]*=[[:space:]]*12" "$dropin"
            for key in dcredit ucredit ocredit lcredit; do
              grep -Eq "^${key}[[:space:]]*=[[:space:]]*-1" "$dropin"
            done

            echo "=== Log Monitoring ==="
            if ! systemctl status rsyslog --no-pager; then
              systemctl reset-failed rsyslog || true
              systemctl restart rsyslog || true
              sleep 5
              if ! systemctl status rsyslog --no-pager; then
                echo "systemctl failed to start rsyslog; attempting manual rsyslogd launch for validation..."
                journalctl -xeu rsyslog || true
                rsyslogd -N1 || true
                rsyslogd -n &
                sleep 3
              fi
            fi

            echo "=== logrotate config ==="
            test -f /etc/logrotate.d/hardening-logs
            cat /etc/logrotate.d/hardening-logs
            mkdir -p /var/lib/logrotate
            LOGROTATE_STATE=/var/lib/logrotate/hardening.status
            if ! logrotate -v -f -s "$LOGROTATE_STATE" /etc/logrotate.d/hardening-logs; then
              echo "logrotate exited non-zero (likely warnings); continuing."
            fi
            test -f "$LOGROTATE_STATE"

            echo "=== logwatch output ==="
            if command -v logwatch >/dev/null 2>&1; then
              logwatch --output file --filename /var/log/logwatch/logwatch.log --range today --detail Med || true
              logwatch --output file --filename /var/log/logwatch/logwatch-latest.log --range today --detail Med || true
            fi
            test -f /var/log/logwatch/logwatch.log
            test -f /var/log/logwatch/logwatch-latest.log
            ls -l /var/log/logwatch/
            test -s /var/log/logwatch/logwatch-latest.log
          '

      - name: Output logs on failure
        if: failure()
        run: |
          container="${{ matrix.name }}"
          echo "---- /var/log/server_hardening.log ----"
          docker exec "$container" bash -lc 'cat /var/log/server_hardening.log || true'
          echo "---- /var/log/server_hardening_error.log ----"
          docker exec "$container" bash -lc 'cat /var/log/server_hardening_error.log || true'
          echo "---- /etc/logrotate.d/hardening-logs ----"
          docker exec "$container" bash -lc 'cat /etc/logrotate.d/hardening-logs || true'
          echo "---- /var/log/logwatch/logwatch-latest.log ----"
          docker exec "$container" bash -lc 'tail -n 200 /var/log/logwatch/logwatch-latest.log 2>/dev/null || true'
          echo "---- rsyslog status ----"
          docker exec "$container" bash -lc 'systemctl status rsyslog --no-pager || true'

      - name: Cleanup
        if: always()
        run: docker rm -f "${{ matrix.name }}"
